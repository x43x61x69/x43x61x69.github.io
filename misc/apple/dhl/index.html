<!--
// Copyright (C) 2020  Zhi-Wei Cai.
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
//
-->
<html>
  <head>
    <title="Apple - DHL Express">
    <style>
      iframe
      {
        width: 100%;
        height: 80%;
      }
    </style>
  </head>
    <body>
      <label for="locale">Tracking #:</label>
      <input type="text" id="awb" name="awb" placeholder="Tracking #">
      <button onclick="load()">Load</button>
      <br />
      <label for="locale">Localization:</label>
	  <select id="locale" name="locale">
		<option value="ZT" selected>正體中文</option>
		<option value="ZH">簡體中文</option>
		<option value="ZF">English</option>
		<option value="JP">日本語</option>
	  </select>
      <br />
      <label for="locale">Step:</label>
      <button onclick="prev()">Prev</button>
      <input type="text" id="step" name="step" value="1" placeholder="Step(s)">
      <button onclick="next()">Next</button>
      <br />
      <iframe id="dhlView" name="dhlView" onload="checkIframeLoaded();"></iframe>
      <script>

        const sample = 8477545215;
        const url = "http://mrt2.ap.dhl.com/mrt?AWB=";

        load();
        document.onkeydown = keyDown;

        function load()
        {
            var awb = parseInt(document.getElementById("awb").value);
            var locale = document.getElementById("locale").value.trim().toUpperCase();
            var localeStr = '';
            if (Number.isNaN(awb) || awb < 0)
            {
              awb = sample;
              document.getElementById("awb").value = awb;
            }
            if (locale)
            {
              localeStr = '&LOCALE=' + locale;
            }
            document.getElementById('dhlView').src = url + awb.toString() + localeStr;
        }
        function checkIframeLoaded()
        {
            // Get a handle to the iframe element
            var iframe = document.getElementById('dhlView');
            var iframeDoc = iframe.contentDocument;

            // Check if loading is complete
            if (  iframeDoc.readyState  == 'complete' ) {
                // The loading is complete, call the function we want executed once the iframe is loaded
                afterLoading();
                return;
            }

            // If we are here, it is not loaded. Set things up so we check   the status again in 100 milliseconds
            window.setTimeout(checkIframeLoaded, 100);
        }
        function afterLoading()
        {
          console.log(document.getElementById('destinationURL4'));
        }
        function keyDown(e)
        {
            e = e || window.event;
            if (e.keyCode == '37')
            {
               prev();
            }
            else if (e.keyCode == '39')
            {
               next();
            }
            else if (e.keyCode == '82')
            {
               load();
            }
        }
        function prev()
        {
            var step = parseInt(document.getElementById("step").value);
            jump(step * -1);
        }
        function next()
        {
            var step = parseInt(document.getElementById("step").value);
            jump(step);
        }
        function jump(step)
        {
            var steps = parseInt(step);
            if (Number.isNaN(steps) || steps == 0)
            {
              steps = 1;
              document.getElementById("step").value = steps;
            }
            var awb = checksum((parseInt(document.getElementById("awb").value.substr(0, 9)) + steps).toString());
            document.getElementById("awb").value = awb;
            load();
        }
        function checksum(awb)
        {
          var sum = parseInt(awb)%7;
          return awb.substr(0, 9) + sum;
        }
      </script>
    </body>
</html>
